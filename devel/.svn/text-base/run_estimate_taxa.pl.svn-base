#!/usr/local/bin/perl

use strict;
use Config::IniFiles;
use FindBin;
require "$FindBin::Bin/mg_lib.pl";

&print_time("STARTTIME");

my $file = $ARGV[0];
my $results_path = $ARGV[1];
my $snapshot_dir = $ARGV[2];
my $config = $ARGV[3];

my $program_path = $0;
my @prog = split '/', $program_path;
my $program = pop @prog;

my $perccomp = "/usr/local/devel/VIRIFX/software/AnnotationTools/Estimate_Taxa_from_Alignment/uniref_to_percid_taxaid/btab_to_perccomp.pl";
my $remap = "/usr/local/devel/VIRIFX/software/ColumnTools/remap_column_values.pl";
my $estimate = "/usr/local/devel/VIRIFX/software/AnnotationTools/Estimate_Taxa_from_Alignment/Estimate_Taxa_from_Alignment.pl";

my $uniprot_info = "$snapshot_dir/Uniprot_info.tsv";
my $nodes = "$snapshot_dir/nodes.tsv";
my $names = "$snapshot_dir/names.tsv";

my $cfg;
if ($config) {
	$cfg = Config::IniFiles->new( -file => "$config" ) || die "cannot parse user suplied config file.\n";
}

my $pc_out = "$file.perc_id";
my $pc_cmd = "$perccomp -b $file > $pc_out";
print "$pc_cmd\n";
system $pc_cmd;

my $sed_cmd = "sed 's/UniRef[0-9]*_//' $pc_out -i";
system $sed_cmd;

my $remap_out = "$pc_out.taxa_id";
my $remap_cmd = "$remap -i $pc_out -m $uniprot_info -c 2 -p -f > $remap_out";
print "$remap_cmd\n";
system $remap_cmd;

my $est_out = "$results_path/taxa_summary.tsv";
my $estimate_cmd = "$estimate -a $remap_out -t $nodes -n $names -o $est_out -h";
print "$estimate_cmd\n";
system $estimate_cmd;

&print_time("ENDTIME");